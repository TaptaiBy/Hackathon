<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proofpulse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: url('assets/images/DB_BG.jpg') no-repeat center center fixed;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background-color: #0000FF;
      z-index: 3;
      position: relative;
    }
    .logo img {
      height: 50px;
    }
    .redeem-btn {
      background-color: #fff;
      color: #0000FF;
      font-weight: bold;
      font-size: 16px;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .redeem-btn:hover {
      background-color: #ffe6f0;
    }
    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* 0.5 = 50% black */
      z-index: 1;
    }
    .main-content {
      position: relative;
      z-index: 2;
    }
    .container {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 2rem;
      grid-template-areas:
        "character character character"
        "metrics activity rewards"
        "quests quests quests"
        "streaks streaks streaks";
    }
    .card {
      background: #fff;
      color: #222;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .card h3 {
      margin-top: 0;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats-table td {
      padding: 0.5rem 0;
    }
    .progress {
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-bar {
      height: 10px;
      background: #FF00B4;
    }
    .character-card {
      grid-area: character;
      padding: 2.5rem;
      font-size: 1.1rem;
      text-align: center;
    }
    .character-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin-bottom: 1rem;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .metrics-card { grid-area: metrics; }
    .activity-card { grid-area: activity; }
    .rewards-card { grid-area: rewards; }
    .quests-card { grid-area: quests; }

    #activity-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.75rem;
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 20px;
      color: #222;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      margin-top: 1rem;
    }
    #activity-calendar div {
      text-align: center;
      padding: 1rem;
      border-radius: 12px;
      font-weight: 600;
      background-color: #f3f3f3;
      transition: all 0.2s ease;
    }
    #activity-calendar div:hover {
      transform: scale(1.05);
      background-color: #eaeaea;
    }
    #activity-calendar .weekday {
      background-color: transparent;
      color: #333;
      font-weight: 700;
      padding: 0.5rem 0;
      cursor: default;
    }
    #activity-calendar .active-day {
      background-color: #d1e7dd;
      color: #155724;
    }
    .quest-item { padding: .5rem 0; display:flex; justify-content:space-between; gap:.75rem; }
    .quest-item.done { color: #1e7e34; font-weight: 600; } /* green when done */
    .quest-status { opacity:.8; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html"><img src="assets/images/logobw.png" alt="Proofpulse" /></a>
    </div>
    <div>
      <button class="redeem-btn" onclick="redeemAllEligible()">ğŸ Redeem</button>
      <a href="index.html" style="color: white; margin-left: 1rem;">Logout</a>
    </div>
  </header>

  <div class="bg-overlay"></div>
  <div class="main-content">
    <div class="container">
      <h1>Welcome, FitWarrior! âœ¨</h1>
  
      <div class="dashboard">
        <div class="card character-card">
          <img src="https://cdn-icons-png.flaticon.com/512/5719/5719910.png" alt="Avatar" class="character-avatar">
          <h3>ğŸ‘¤ Character Status</h3>

          <h3>ğŸ‘¤ Character Status</h3>
          <p><strong>Level:</strong> <span id="level-value">-</span></p>
          <p><strong>XP:</strong> <span id="xp-value">-</span></p>

          <div class="progress">
          <div class="progress-bar" style="width: 0%"></div>
          </div>

          <p><strong>Badges:</strong> Early Bird</p>
          <hr style="margin: 1.5rem 0;">

          <div class="mt-4 p-4 border rounded bg-white text-black" style="margin-top:1.5rem;">
        <h3>ğŸ§  Upload GPX for Verification</h3>
        <input type="file" id="gpxFileInput" accept=".gpx" />
        <button onclick="verifyWorkout()" class="btn mt-2 bg-blue-600 text-white px-4 py-2 rounded">Start Verification</button>
       <div id="mlResult" class="mt-2 text-sm text-gray-800"></div>
        </div>
           <hr style="margin: 1.5rem 0;">

                 
          <h3>ğŸ©º Health ID Proof</h3>
          
          <p>Date of Birth: <span id="health-dob">Loading...</span></p>
          <p>Policy No: <span id="health-policy">Loading...</span></p>
          <p>Contract Value: <span id="health-contract">Loading...</span></p>
          <p>Insurer: <span id="health-insurer">Loading...</span></p>



        </div>
  
        <div class="card metrics-card">
          <h3>ğŸ‹ï¸ Body Metrics</h3>
          <table class="stats-table">
            <tr><td>Height:</td><td>169 cm</td></tr>
            <tr><td>Weight:</td><td>77.3 kg</td></tr>
            <tr><td>Body Fat:</td><td>20.8%</td></tr>
          </table>
        </div>
  
        <div class="card activity-card">
          <h3>ğŸš¶ï¸ Daily Activity</h3>
          <table class="stats-table">
            <tr><td>Steps:</td><td id="steps">-</td></tr>
            <tr><td>Sleep:</td><td id="sleep">-</td></tr>
            <tr><td>Calories:</td><td id="calories">-</td></tr>
          </table>
        </div>
  
        <div class="card rewards-card">
        <h3>ğŸŒŸ Total Rewards</h3>
        
        <p><strong>Total ETH earned:</strong> <span id="total-earned">â€”</span></p>
        <p><strong>Today:</strong> <span id="earned-today">â€”</span></p>
        <p><strong>Redeemable now:</strong> <span id="redeemable-now">Calculatingâ€¦</span></p>
        </div>


  
        <div class="card quests-card quests">
          <h3>ğŸš€ Daily Quests</h3>
          <ul id="daily-quests" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>
  
        <div class="card quests-card" style="grid-area: streaks;">
          <h3>ğŸ“… Activity Calendar</h3>
          <div style="margin-bottom: 1rem;">
            <label for="quest-filter" style="margin-right: 0.5rem;">Filter by Quest:</label>
            <select id="quest-filter">
              <option value="all">All</option>
              <option value="walking">ğŸš¶ Walking</option>
              <option value="running30min">ğŸƒâ€â™‚ï¸ Run 30min</option>
              <option value="running45min">ğŸƒâ€â™‚ï¸ Run 45min</option>
              <option value="run5k">ğŸ Run 5K</option>
              <option value="run10k">ğŸ Run 10K</option>
              <option value="cycling5k">ğŸš´â€â™‚ï¸ Cycle 5K</option>
              <option value="cycling10k">ğŸš´â€â™‚ï¸ Cycle 10K</option>
              <option value="gym_checkin">ğŸ‹ï¸â€â™‚ï¸ Gym Check-in</option>
              <option value="hiit25">ğŸ”¥ HIIT 25min</option>
            </select>
          </div>
          <div id="activity-calendar"></div>
        </div>
      </div>
    </div>
  </div>


<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* ===== Addresses & ABIs ===== */
const activityLoggerAddress = "0x26E24bfe2A21515eb91Cea4b754FA56067bC70cB";
const healthIdAddress      = "0x7bC0fC7A7EF15FA2839c32F6a3b04B2edD3e3e68";

const activityLoggerAbi = [
  "function getUserActivities(address user) view returns ((uint256 distanceKmX100,uint256 elevationGainM,uint256 timestamp,bool isRewarded)[])",
  "function getThresholds() view returns (uint256 distanceThreshold,uint256 elevationThreshold)",
  "function rewardAmount() view returns (uint256)",
  "function redeemReward()",
  "event ActivityLogged(address indexed user,uint256 distanceKmX100,uint256 elevationGainM,uint256 timestamp)",
  "event RewardRedeemed(address indexed user,uint256 amount,uint256 eligibleCount)"
];

const healthIdAbi = [
  {
    "inputs":[{"internalType":"address","name":"","type":"address"}],
    "name":"users",
    "outputs":[
      {"internalType":"address","name":"user","type":"address"},
      {"internalType":"string","name":"name","type":"string"},
      {"internalType":"uint256","name":"dob","type":"uint256"},
      {"internalType":"string","name":"policyNo","type":"string"},
      {"internalType":"uint256","name":"contractValue","type":"uint256"},
      {"internalType":"address","name":"insurer","type":"address"}
    ],
    "stateMutability":"view","type":"function"
  },
  {
    "inputs":[{"internalType":"address","name":"user","type":"address"}],
    "name":"getUserInsurerInfo",
    "outputs":[
      {"internalType":"string","name":"insurerName","type":"string"},
      {"internalType":"address","name":"insurerAddress","type":"address"},
      {"internalType":"string","name":"licenseInfo","type":"string"}
    ],
    "stateMutability":"view","type":"function"
  }
];

/* ===== Character constants ===== */
const XP_PER_ACTIVITY = 10;
const XP_PER_LEVEL = 100;

/* ===== Small helpers ===== */
function formatDobValue(dobBig) {
  const val = typeof dobBig === "object" && dobBig?._isBigNumber
    ? parseInt(dobBig.toString(), 10)
    : Number(dobBig);
  if (!val || Number.isNaN(val)) return "Not set";
  const date = val > 10000000000 ? new Date(val) : new Date(val * 1000);
  return date.toLocaleDateString("en-GB");
}

/* ===== Boot flow ===== */
async function initCharacterStatus() {
  try {
    if (!window.ethereum) throw new Error("Wallet not found");
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const user = await signer.getAddress();

    // Character status
    const activity = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const activities = await activity.getUserActivities(user);
    const count = activities.length;
    const xp = count * XP_PER_ACTIVITY;
    const level = Math.floor(xp / XP_PER_LEVEL) + 1;
    const xpIntoLevel = xp % XP_PER_LEVEL;
    const pct = Math.floor((xpIntoLevel / XP_PER_LEVEL) * 100);

    document.getElementById("level-value").textContent = level;
    document.getElementById("xp-value").textContent = xp;
    document.querySelector(".progress-bar").style.width = pct + "%";

    // Health + Rewards
    await loadHealthID(user, provider);
    await loadOverallEarnings(provider, user);
    await loadRedeemableValue(provider, user);

    // Daily activity mock (unchanged)
    fetchMockData();

    // Quests: render + evaluate for today
    loadDailyQuests();
    await updateDailyQuestStatus(provider, user);

    // Live refresh on Activity/Reward events
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    logger.on("ActivityLogged", (u) => {
      if (u.toLowerCase() === user.toLowerCase()) {
        updateDailyQuestStatus(provider, user);
        loadOverallEarnings(provider, user);
        loadRedeemableValue(provider, user);
      }
    });
    logger.on("RewardRedeemed", (u) => {
      if (u.toLowerCase() === user.toLowerCase()) {
        loadOverallEarnings(provider, user);
        loadRedeemableValue(provider, user);
      }
    });

  } catch (err) {
    console.error(err);
  }
}

/* ===== HealthID ===== */
async function loadHealthID(userAddress, provider) {
  try {
    const health = new ethers.Contract(healthIdAddress, healthIdAbi, provider);
    const u = await health.users(userAddress);
    if (u.name && u.name.length) {
      const h1 = document.querySelector("h1");
      if (h1) h1.textContent = `Welcome, ${u.name}! âœ¨`;
    }
    document.getElementById("health-dob").textContent      = formatDobValue(u.dob);
    document.getElementById("health-policy").textContent   = u.policyNo;
    document.getElementById("health-contract").textContent = `${ethers.utils.formatEther(u.contractValue)} ETH`;
    const info = await health.getUserInsurerInfo(userAddress);
    document.getElementById("health-insurer").textContent  = `${info.insurerName} (${info.insurerAddress})`;
  } catch (error) {
    console.error("Error loading Health ID:", error);
  }
}

/* ===== Mock daily activity ===== */
async function fetchMockData() {
  try {
    const response = await fetch('assets/mock/mockhealthdata.json');
    const data = await response.json();
    document.querySelector('#steps').textContent   = `${data.steps.toLocaleString()} steps`;
    document.querySelector('#sleep').textContent   = `${data.sleep} hrs`;
    document.querySelector('#calories').textContent= `${data.calories} kcal`;
  } catch (error) {
    console.error('Failed to fetch mock data:', error);
  }
}

/* ===== Rewards: Redeemable now (unpaid eligibles) ===== */
async function loadRedeemableValue(provider, userAddress) {
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const [activities, [distTh, elevTh], rewardWei] = await Promise.all([
      logger.getUserActivities(userAddress),
      logger.getThresholds(),
      logger.rewardAmount()
    ]);

    let eligible = 0;
    for (const a of activities) {
      const distOK = ethers.BigNumber.from(a.distanceKmX100 ?? a[0]).gte(distTh);
      const elevOK = ethers.BigNumber.from(a.elevationGainM ?? a[1]).gte(elevTh);
      const notPaid = !(a.isRewarded ?? a[3]);
      if (notPaid && (distOK || elevOK)) eligible++;
    }

    const totalWei = ethers.BigNumber.from(rewardWei).mul(eligible);
    document.getElementById("redeemable-now").textContent =
      eligible > 0 ? `${ethers.utils.formatEther(totalWei)} ETH` : "0 ETH";

  } catch (e) {
    console.error("Failed to load redeemable value:", e);
    const el = document.getElementById("redeemable-now");
    if (el) el.textContent = "â€”";
  }
}

/* ===== Rewards: Overall earnings (all eligible ever) + Today (eligible since midnight) ===== */
async function loadOverallEarnings(provider, userAddress) {
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const [activities, [distTh, elevTh], rewardWei] = await Promise.all([
      logger.getUserActivities(userAddress),
      logger.getThresholds(),
      logger.rewardAmount(),
    ]);

    const midnight = new Date(); midnight.setHours(0,0,0,0);
    const todayStart = Math.floor(midnight.getTime() / 1000);

    let totalEligible = 0;
    let todayEligible = 0;

    for (const a of activities) {
      const dist = a.distanceKmX100 ?? a[0];
      const elev = a.elevationGainM ?? a[1];
      const ts   = Number(a.timestamp ?? a[2]);

      const eligible = ethers.BigNumber.from(dist).gte(distTh) || ethers.BigNumber.from(elev).gte(elevTh);
      if (eligible) {
        totalEligible++;
        if (ts >= todayStart) todayEligible++;
      }
    }

    const totalWei = ethers.BigNumber.from(rewardWei).mul(totalEligible);
    const todayWei = ethers.BigNumber.from(rewardWei).mul(todayEligible);

    document.getElementById("total-earned").textContent = `${ethers.utils.formatEther(totalWei)} ETH`;
    document.getElementById("earned-today").textContent = `+${ethers.utils.formatEther(todayWei)} ETH`;

  } catch (e) {
    console.error("Failed to load overall earnings:", e);
    const te = document.getElementById("total-earned");
    const td = document.getElementById("earned-today");
    if (te) te.textContent = "â€”";
    if (td) td.textContent = "â€”";
  }
}

/* ===== Redeem button ===== */
async function redeemAllEligible() {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const contract = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, signer);

    const btn = document.querySelector(".redeem-btn");
    if (btn) { btn.disabled = true; btn.textContent = "Redeemingâ€¦"; }
    const tx = await contract.redeemReward();
    await tx.wait();
    if (btn) { btn.disabled = false; btn.textContent = "ğŸ Redeem"; }

    const user = await signer.getAddress();
    await loadRedeemableValue(provider, user);
    await loadOverallEarnings(provider, user);
    await updateDailyQuestStatus(provider, user);

  } catch (e) {
    console.error("Redeem failed:", e);
    const btn = document.querySelector(".redeem-btn");
    if (btn) { btn.disabled = false; btn.textContent = "ğŸ Redeem"; }
  }
}

/* ===== Quests (render + today-only completion for 5km & 100m) ===== */
function loadDailyQuests() {
  const css = document.createElement("style");
  css.textContent = `
    .quest-item { padding:.5rem 0; display:flex; justify-content:space-between; gap:.75rem; }
    .quest-item.done { color:#1e7e34; font-weight:600; }
    .quest-status { opacity:.85; }
  `;
  document.head.appendChild(css);

  const ul = document.getElementById("daily-quests");
  ul.innerHTML = `
    <li id="quest-5k"   class="quest-item">ğŸ Run 5 km <span class="quest-status">â³ Not yet</span></li>
    <li id="quest-elev" class="quest-item">â›°ï¸ Step up 100 m <span class="quest-status">â³ Not yet</span></li>
    <li id="quest-sleep" class="quest-item">ğŸ’¤ Sleep 8 hours <span class="quest-status">â³ Not yet</span></li>
    <li id="quest-ex30"  class="quest-item">ğŸ’ª Exercise 30 minutes <span class="quest-status">â³ Not yet</span></li>
  `;
}

function setQuestState(id, done) {
  const li = document.getElementById(id);
  if (!li) return;
  li.classList.toggle("done", done);
  li.querySelector(".quest-status").textContent = done ? "âœ… Completed" : "â³ Not yet";
}

async function updateDailyQuestStatus(provider, userAddress) {
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const activities = await logger.getUserActivities(userAddress);

    // today-only window
    const midnight = new Date(); midnight.setHours(0,0,0,0);
    const todayStart = Math.floor(midnight.getTime() / 1000);

    let did5k = false, didElev = false;

    for (const a of activities) {
      const dist = a.distanceKmX100 ?? a[0];   // x100 (500 => 5.00 km)
      const elev = a.elevationGainM ?? a[1];   // meters
      const ts   = Number(a.timestamp ?? a[2]);
      if (ts < todayStart) continue;

      if (ethers.BigNumber.from(dist).gte(500)) did5k = true;
      if (ethers.BigNumber.from(elev).gte(100)) didElev = true;

      if (did5k && didElev) break;
    }

    setQuestState("quest-5k", did5k);
    setQuestState("quest-elev", didElev);
    // Sleep 8h & Exercise 30m remain static (no logic requested)

  } catch (e) {
    console.error("Failed to update quests:", e);
  }
}

/* ===== Boot ===== */
window.addEventListener("load", initCharacterStatus);
</script>




<script src="/static/main.js"></script>
</body>
</html>
