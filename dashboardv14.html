
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proofpulse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: url('assets/images/DB_BG.jpg') no-repeat center center fixed;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background-color: #0000FF;
      z-index: 3;
      position: relative;
    }
    .logo img {
      height: 50px;
    }
    .redeem-btn {
      background-color: #fff;
      color: #0000FF;
      font-weight: bold;
      font-size: 16px;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .redeem-btn:hover {
      background-color: #ffe6f0;
    }
    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* 0.5 = 50% black */
      z-index: 1;
    }
    .main-content {
      position: relative;
      z-index: 2;
    }
    .container {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 2rem;
      grid-template-areas:
        "character character character"
        "metrics activity rewards"
        "quests quests quests"
        "streaks streaks streaks";
    }
    .card {
      background: #fff;
      color: #222;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .card h3 {
      margin-top: 0;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats-table td {
      padding: 0.5rem 0;
    }
    .progress {
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-bar {
      height: 10px;
      background: #FF00B4;
    }
    .character-card {
      grid-area: character;
      padding: 2.5rem;
      font-size: 1.1rem;
      text-align: center;
    }
    .character-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin-bottom: 1rem;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .metrics-card { grid-area: metrics; }
    .activity-card { grid-area: activity; }
    .rewards-card { grid-area: rewards; }
    .quests-card { grid-area: quests; }

    #activity-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.75rem;
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 20px;
      color: #222;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      margin-top: 1rem;
    }
    #activity-calendar div {
      text-align: center;
      padding: 1rem;
      border-radius: 12px;
      font-weight: 600;
      background-color: #f3f3f3;
      transition: all 0.2s ease;
    }
    #activity-calendar div:hover {
      transform: scale(1.05);
      background-color: #eaeaea;
    }
    #activity-calendar .weekday {
      background-color: transparent;
      color: #333;
      font-weight: 700;
      padding: 0.5rem 0;
      cursor: default;
    }
    #activity-calendar .active-day {
      background-color: #d1e7dd;
      color: #155724;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html"><img src="assets/images/logobw.png" alt="Proofpulse" /></a>
    </div>
    <div>
      <button class="redeem-btn" onclick="redeemAllEligible()">ğŸ Redeem</button>
      <a href="index.html" style="color: white; margin-left: 1rem;">Logout</a>
    </div>
  </header>

  <div class="bg-overlay"></div>
  <div class="main-content">
    <div class="container">
      <h1>Welcome, FitWarrior! âœ¨</h1>
  
      <div class="dashboard">
        <div class="card character-card">
          <img src="https://cdn-icons-png.flaticon.com/512/5719/5719910.png" alt="Avatar" class="character-avatar">
          <h3>ğŸ‘¤ Character Status</h3>

          <h3>ğŸ‘¤ Character Status</h3>
          <p><strong>Level:</strong> <span id="level-value">-</span></p>
          <p><strong>XP:</strong> <span id="xp-value">-</span></p>

          <div class="progress">
          <div class="progress-bar" style="width: 0%"></div>
          </div>

          <p><strong>Badges:</strong> Early Bird</p>
          <hr style="margin: 1.5rem 0;">

          <div class="mt-4 p-4 border rounded bg-white text-black" style="margin-top:1.5rem;">
        <h3>ğŸ§  Upload GPX for Verification</h3>
        <input type="file" id="gpxFileInput" accept=".gpx" />
        <button onclick="verifyWorkout()" class="btn mt-2 bg-blue-600 text-white px-4 py-2 rounded">Start Verification</button>
       <div id="mlResult" class="mt-2 text-sm text-gray-800"></div>
        </div>
          
          <h3>ğŸ©º Health ID Proof</h3>
          <p>Hashtx: <span id="tx">Loading...</span></p> 
          <p>Date of Birth: <span id="health-dob">Loading...</span></p>
          <p>Policy No: <span id="health-policy">Loading...</span></p>
          <p>Contract Value: <span id="health-contract">Loading...</span></p>
          <p>Insurer: <span id="health-insurer">Loading...</span></p>



        </div>
  
        <div class="card metrics-card">
          <h3>ğŸ‹ï¸ Body Metrics</h3>
          <table class="stats-table">
            <tr><td>Height:</td><td>169 cm</td></tr>
            <tr><td>Weight:</td><td>77.3 kg</td></tr>
            <tr><td>Body Fat:</td><td>20.8%</td></tr>
          </table>
        </div>
  
        <div class="card activity-card">
          <h3>ğŸš¶ï¸ Daily Activity</h3>
          <table class="stats-table">
            <tr><td>Steps:</td><td id="steps">-</td></tr>
            <tr><td>Sleep:</td><td id="sleep">-</td></tr>
            <tr><td>Calories:</td><td id="calories">-</td></tr>
          </table>
        </div>
  
        <div class="card rewards-card">
          <h3>ğŸŒŸ Points & Rewards</h3>
          <p><strong>Total Points:</strong> 1,250</p>
          <p><strong>Today:</strong> +120</p>
          <div class="progress"><div class="progress-bar" style="width: 75%"></div></div>
          <p>Next reward at 1500 pts</p>
        </div>
  
        <div class="card quests-card quests">
          <h3>ğŸš€ Daily Quests</h3>
          <ul id="daily-quests" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>
  
        <div class="card quests-card" style="grid-area: streaks;">
          <h3>ğŸ“… Activity Calendar</h3>
          <div style="margin-bottom: 1rem;">
            <label for="quest-filter" style="margin-right: 0.5rem;">Filter by Quest:</label>
            <select id="quest-filter">
              <option value="all">All</option>
              <option value="walking">ğŸš¶ Walking</option>
              <option value="running30min">ğŸƒâ€â™‚ï¸ Run 30min</option>
              <option value="running45min">ğŸƒâ€â™‚ï¸ Run 45min</option>
              <option value="run5k">ğŸ Run 5K</option>
              <option value="run10k">ğŸ Run 10K</option>
              <option value="cycling5k">ğŸš´â€â™‚ï¸ Cycle 5K</option>
              <option value="cycling10k">ğŸš´â€â™‚ï¸ Cycle 10K</option>
              <option value="gym_checkin">ğŸ‹ï¸â€â™‚ï¸ Gym Check-in</option>
              <option value="hiit25">ğŸ”¥ HIIT 25min</option>
            </select>
          </div>
          <div id="activity-calendar"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
 <script>
  const activityLoggerAddress = "0xa1Bfa3017471fb82dbC5e7e6E2Fe4501825337eE";
  const healthIdAddress = "0xec080955027c09bF04547036776B0392F8C4A3B2";
  const activityLoggerAbi = [
    "function getUserActivities(address user) view returns ((uint256 distanceKmX100,uint256 elevationGainM,bool isRewarded)[])"
  ];
  const healthIdAbi = [
  {
    "inputs": [
      { "internalType": "address", "name": "", "type": "address" }
    ],
    "name": "users",
    "outputs": [
      { "internalType": "address", "name": "user", "type": "address" },
      { "internalType": "string", "name": "name", "type": "string" },
      { "internalType": "uint256", "name": "dob", "type": "uint256" },
      { "internalType": "string", "name": "policyNo", "type": "string" },
      { "internalType": "uint256", "name": "contractValue", "type": "uint256" },
      { "internalType": "address", "name": "insurer", "type": "address" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      { "internalType": "address", "name": "user", "type": "address" }
    ],
    "name": "getUserInsurerInfo",
    "outputs": [
      { "internalType": "string", "name": "insurerName", "type": "string" },
      { "internalType": "address", "name": "insurerAddress", "type": "address" },
      { "internalType": "string", "name": "licenseInfo", "type": "string" }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "anonymous": false,
    "inputs": [
      { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
      { "indexed": false, "internalType": "string", "name": "name", "type": "string" },
      { "indexed": false, "internalType": "address", "name": "insurer", "type": "address" },
      { "indexed": false, "internalType": "uint256", "name": "contractValue", "type": "uint256" }
    ],
    "name": "UserRegistered",
    "type": "event"
  }
];


 ///////// Character status Part//////
  const XP_PER_ACTIVITY = 10;
  const XP_PER_LEVEL = 100;
   
    async function initCharacterStatus() {
    try {
      if (!window.ethereum) throw new Error("Wallet not found");
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const user = await signer.getAddress();

      const contract = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
      const activities = await contract.getUserActivities(user);

      const count = activities.length;
      const xp = count * XP_PER_ACTIVITY;
      const level = Math.floor(xp / XP_PER_LEVEL) + 1;
      const xpIntoLevel = xp % XP_PER_LEVEL;
      const pct = Math.floor((xpIntoLevel / XP_PER_LEVEL) * 100);

      document.getElementById("level-value").textContent = level;
      document.getElementById("xp-value").textContent = xp;
      document.querySelector(".progress-bar").style.width = pct + "%";

    await loadHealthID(user);
      
    } catch (err) {
      console.error(err);
    }
  }

  ////////Health ID Part///////

 async function loadHealthID(userAddress) {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    const healthIDContract = new ethers.Contract(healthIdAddress, healthIdAbi, provider);

    // Fetch Health ID details
    const result = await healthIDContract.users(userAddress);

    // Format DOB
    let formattedDob;
    const dobStr = result.dob.toString();
    if (dobStr.length === 8) {
      // DDMMYYYY
      formattedDob = `${dobStr.slice(0, 2)}/${dobStr.slice(2, 4)}/${dobStr.slice(4)}`;
    } else {
      // Timestamp
      formattedDob = new Date(Number(result.dob) * 1000).toLocaleDateString("en-GB");
    }

    document.getElementById('health-dob').textContent = formattedDob;
    document.getElementById('health-policy').textContent = result.policyNo;
    document.getElementById('health-contract').textContent =
      `${ethers.utils.formatEther(result.contractValue)} ETH`;
    
    const insurerInfo = await healthIDContract.getUserInsurerInfo(userAddress);
    document.getElementById('health-insurer').textContent = `${insurerInfo.insurerName} (${insurerInfo.insurerAddress})`;


    // Get last UserRegistered event
    const filter = healthIDContract.filters.UserRegistered(userAddress, null, null, null);
    const events = await healthIDContract.queryFilter(filter, 0, "latest");

    if (events.length > 0) {
      const txHash = events[events.length - 1].transactionHash;
      document.getElementById('tx').innerHTML =
        `<a href="https://holesky.etherscan.io/tx/${txHash}" target="_blank">${txHash}</a>`;
    } else {
      document.getElementById('tx').textContent = 'Not found';
    }

  } catch (error) {
    console.error("Error loading Health ID:", error);
  }
}

////////////
   
  window.addEventListener("load", initCharacterStatus);
  
   
</script>


<script src="/static/main.js"></script>
</body>
</html>
