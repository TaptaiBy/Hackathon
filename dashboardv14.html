<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proofpulse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: url('assets/images/DB_BG.jpg') no-repeat center center fixed;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background-color: #0000FF;
      z-index: 3;
      position: relative;
    }
    .logo img {
      height: 50px;
    }
    .redeem-btn {
      background-color: #fff;
      color: #0000FF;
      font-weight: bold;
      font-size: 16px;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .redeem-btn:hover {
      background-color: #ffe6f0;
    }
    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5); /* 0.5 = 50% black */
      z-index: 1;
    }
    .main-content {
      position: relative;
      z-index: 2;
    }
    .container {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 2rem;
      grid-template-areas:
        "character character character"
        "metrics activity rewards"
        "quests quests quests"
        "streaks streaks streaks";
    }
    .card {
      background: #fff;
      color: #222;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: scale(1.02);
    }
    .card h3 {
      margin-top: 0;
    }
    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats-table td {
      padding: 0.5rem 0;
    }
    .progress {
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-bar {
      height: 10px;
      background: #FF00B4;
    }
    .character-card {
      grid-area: character;
      padding: 2.5rem;
      font-size: 1.1rem;
      text-align: center;
    }
    .character-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin-bottom: 1rem;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .metrics-card { grid-area: metrics; }
    .activity-card { grid-area: activity; }
    .rewards-card { grid-area: rewards; }
    .quests-card { grid-area: quests; }

    #activity-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.75rem;
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 20px;
      color: #222;
      font-size: 0.95rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      margin-top: 1rem;
    }
    #activity-calendar div {
      text-align: center;
      padding: 1rem;
      border-radius: 12px;
      font-weight: 600;
      background-color: #f3f3f3;
      transition: all 0.2s ease;
    }
    #activity-calendar div:hover {
      transform: scale(1.05);
      background-color: #eaeaea;
    }
    #activity-calendar .weekday {
      background-color: transparent;
      color: #333;
      font-weight: 700;
      padding: 0.5rem 0;
      cursor: default;
    }
    #activity-calendar .active-day {
      background-color: #d1e7dd;
      color: #155724;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html"><img src="assets/images/logobw.png" alt="Proofpulse" /></a>
    </div>
    <div>
      <button class="redeem-btn" onclick="redeemAllEligible()">🎁 Redeem</button>
      <a href="index.html" style="color: white; margin-left: 1rem;">Logout</a>
    </div>
  </header>

  <div class="bg-overlay"></div>
  <div class="main-content">
    <div class="container">
      <h1>Welcome, FitWarrior! ✨</h1>
  
      <div class="dashboard">
        <div class="card character-card">
          <img src="https://cdn-icons-png.flaticon.com/512/5719/5719910.png" alt="Avatar" class="character-avatar">
          <h3>👤 Character Status</h3>

          <h3>👤 Character Status</h3>
          <p><strong>Level:</strong> <span id="level-value">-</span></p>
          <p><strong>XP:</strong> <span id="xp-value">-</span></p>

          <div class="progress">
          <div class="progress-bar" style="width: 0%"></div>
          </div>

          <p><strong>Badges:</strong> Early Bird</p>
          <hr style="margin: 1.5rem 0;">

          <div class="mt-4 p-4 border rounded bg-white text-black" style="margin-top:1.5rem;">
        <h3>🧠 Upload GPX for Verification</h3>
        <input type="file" id="gpxFileInput" accept=".gpx" />
        <button onclick="verifyWorkout()" class="btn mt-2 bg-blue-600 text-white px-4 py-2 rounded">Start Verification</button>
       <div id="mlResult" class="mt-2 text-sm text-gray-800"></div>
        </div>
           <hr style="margin: 1.5rem 0;">

                 
          <h3>🩺 Health ID Proof</h3>
          
          <p>Date of Birth: <span id="health-dob">Loading...</span></p>
          <p>Policy No: <span id="health-policy">Loading...</span></p>
          <p>Contract Value: <span id="health-contract">Loading...</span></p>
          <p>Insurer: <span id="health-insurer">Loading...</span></p>



        </div>
  
        <div class="card metrics-card">
          <h3>🏋️ Body Metrics</h3>
          <table class="stats-table">
            <tr><td>Height:</td><td>169 cm</td></tr>
            <tr><td>Weight:</td><td>77.3 kg</td></tr>
            <tr><td>Body Fat:</td><td>20.8%</td></tr>
          </table>
        </div>
  
        <div class="card activity-card">
          <h3>🚶️ Daily Activity</h3>
          <table class="stats-table">
            <tr><td>Steps:</td><td id="steps">-</td></tr>
            <tr><td>Sleep:</td><td id="sleep">-</td></tr>
            <tr><td>Calories:</td><td id="calories">-</td></tr>
          </table>
        </div>
  
        <div class="card rewards-card">
        <h3>🌟 Total Rewards</h3>
        <p><strong>Total ETH earned:</strong> 1,250</p>
        <p><strong>Today:</strong> +120</p>

        <p><strong>Redeemable now:</strong> <span id="redeemable-now">Calculating…</span></p>
        </div>


        
  
        <div class="card quests-card quests">
          <h3>🚀 Daily Quests</h3>
          <ul id="daily-quests" style="list-style: none; padding: 0; margin: 0;"></ul>
        </div>
  
        <div class="card quests-card" style="grid-area: streaks;">
          <h3>📅 Activity Calendar</h3>
          <div style="margin-bottom: 1rem;">
            <label for="quest-filter" style="margin-right: 0.5rem;">Filter by Quest:</label>
            <select id="quest-filter">
              <option value="all">All</option>
              <option value="walking">🚶 Walking</option>
              <option value="running30min">🏃‍♂️ Run 30min</option>
              <option value="running45min">🏃‍♂️ Run 45min</option>
              <option value="run5k">🏁 Run 5K</option>
              <option value="run10k">🏁 Run 10K</option>
              <option value="cycling5k">🚴‍♂️ Cycle 5K</option>
              <option value="cycling10k">🚴‍♂️ Cycle 10K</option>
              <option value="gym_checkin">🏋️‍♂️ Gym Check-in</option>
              <option value="hiit25">🔥 HIIT 25min</option>
            </select>
          </div>
          <div id="activity-calendar"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
  // ===== Addresses & minimal ABIs =====
  const activityLoggerAddress = "0x26E24bfe2A21515eb91Cea4b754FA56067bC70cB";
  const healthIdAddress      = "0x7bC0fC7A7EF15FA2839c32F6a3b04B2edD3e3e68";

  
  const activityLoggerAbi = [
  "function getUserActivities(address user) view returns ((uint256 distanceKmX100,uint256 elevationGainM,bool isRewarded)[])",
  "function getThresholds() view returns (uint256 distanceThreshold, uint256 elevationThreshold)",
  "function rewardAmount() view returns (uint256)",
  "event ActivityLogged(address indexed user, uint256 distanceKmX100, uint256 elevationGainM, uint256 timestamp)",
  "event RewardRedeemed(address indexed user, uint256 amount, uint256 eligibleCount)"
];

  // Only what we use: users(), getUserInsurerInfo(), UserRegistered
  const healthIdAbi = [
    {
      "inputs":[{"internalType":"address","name":"","type":"address"}],
      "name":"users",
      "outputs":[
        {"internalType":"address","name":"user","type":"address"},
        {"internalType":"string","name":"name","type":"string"},
        {"internalType":"uint256","name":"dob","type":"uint256"},
        {"internalType":"string","name":"policyNo","type":"string"},
        {"internalType":"uint256","name":"contractValue","type":"uint256"},
        {"internalType":"address","name":"insurer","type":"address"}
      ],
      "stateMutability":"view","type":"function"
    },
    {
      "inputs":[{"internalType":"address","name":"user","type":"address"}],
      "name":"getUserInsurerInfo",
      "outputs":[
        {"internalType":"string","name":"insurerName","type":"string"},
        {"internalType":"address","name":"insurerAddress","type":"address"},
        {"internalType":"string","name":"licenseInfo","type":"string"}
      ],
      "stateMutability":"view","type":"function"
    },
    {
      "anonymous":false,
      "inputs":[
        {"indexed":true,"internalType":"address","name":"user","type":"address"},
        {"indexed":false,"internalType":"string","name":"name","type":"string"},
        {"indexed":false,"internalType":"address","name":"insurer","type":"address"},
        {"indexed":false,"internalType":"uint256","name":"contractValue","type":"uint256"}
      ],
      "name":"UserRegistered","type":"event"
    }
  ];

  // ===== Character status constants =====
  const XP_PER_ACTIVITY = 10;
  const XP_PER_LEVEL = 100;

  // ===== Helpers =====
  function formatDobValue(dobBig) {
    // dob can be BigNumber seconds or milliseconds since epoch (or 0)
    const val = typeof dobBig === "object" && dobBig._isBigNumber
      ? parseInt(dobBig.toString(), 10)
      : Number(dobBig);

    if (!val || Number.isNaN(val)) return "Not set";

    // Heuristic: > 10,000,000,000 => already milliseconds
    const date = val > 10000000000 ? new Date(val) : new Date(val * 1000);
    return date.toLocaleDateString("en-GB");
  }

  // ===== Main loaders =====
  // ===== Character Status Part =====
  async function initCharacterStatus() {
    try {
      if (!window.ethereum) throw new Error("Wallet not found");
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const user = await signer.getAddress();

      // Character status
      const activity = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
      const activities = await activity.getUserActivities(user);

      const count = activities.length;
      const xp = count * XP_PER_ACTIVITY;
      const level = Math.floor(xp / XP_PER_LEVEL) + 1;
      const xpIntoLevel = xp % XP_PER_LEVEL;
      const pct = Math.floor((xpIntoLevel / XP_PER_LEVEL) * 100);

      document.getElementById("level-value").textContent = level;
      document.getElementById("xp-value").textContent = xp;
      document.querySelector(".progress-bar").style.width = pct + "%";

      // Health ID
      await loadHealthID(user, provider);
      await loadRedeemableValue(provider, user);
      
      fetchMockData();

       // Auto-refresh when activity is logged or user redeems
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    logger.on("ActivityLogged", (u) => {
      if (u.toLowerCase() === user.toLowerCase()) loadRedeemableValue(provider, user);
    });
    logger.on("RewardRedeemed", (u) => {
      if (u.toLowerCase() === user.toLowerCase()) loadRedeemableValue(provider, user);
    });

      
    } catch (err) {
      console.error(err);
    }
  }

  
  // ===== HealthID Part =====
async function loadHealthID(userAddress, provider) {
  try {
    const health = new ethers.Contract(healthIdAddress, healthIdAbi, provider);

    // users(address)
    const u = await health.users(userAddress);

    // Update welcome header with HealthID name
    if (u.name && u.name.length) {
      const h1 = document.querySelector("h1");
      if (h1) h1.textContent = `Welcome, ${u.name}! ✨`;
    }

    // Fill proof section (removed Hashtx line)
    document.getElementById("health-dob").textContent      = formatDobValue(u.dob);
    document.getElementById("health-policy").textContent   = u.policyNo;
    document.getElementById("health-contract").textContent = `${ethers.utils.formatEther(u.contractValue)} ETH`;

    // Insurer name/address
    const info = await health.getUserInsurerInfo(userAddress);
    document.getElementById("health-insurer").textContent  = `${info.insurerName} (${info.insurerAddress})`;

  } catch (error) {
    console.error("Error loading Health ID:", error);
  }
}
  // ===== Daily Acitivity Part =====
   async function fetchMockData() {
      try {
        const response = await fetch('assets/mock/mockhealthdata.json');
        const data = await response.json();
        document.querySelector('#steps').textContent = `${data.steps.toLocaleString()} steps`;
        document.querySelector('#sleep').textContent = `${data.sleep} hrs`;
        document.querySelector('#calories').textContent = `${data.calories} kcal`;
      } catch (error) {
        console.error('Failed to fetch mock data:', error);
      }
    }

  // ===== Redeem Reward  Part =====

  async function loadRedeemableValue(provider, userAddress) {
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);

    const [activities, [distTh, elevTh], rewardWei] = await Promise.all([
      logger.getUserActivities(userAddress),
      logger.getThresholds(),
      logger.rewardAmount()
    ]);

    // Count eligible & not-yet-rewarded logs
    let eligible = 0;
    for (const a of activities) {
      const distOK = ethers.BigNumber.from(a.distanceKmX100).gte(distTh);
      const elevOK = ethers.BigNumber.from(a.elevationGainM).gte(elevTh);
      const notPaid = !a.isRewarded;
      if (notPaid && (distOK || elevOK)) eligible++;
    }

    const totalWei = ethers.BigNumber.from(rewardWei).mul(eligible);
    const totalEth = ethers.utils.formatEther(totalWei);

    const el = document.getElementById("redeemable-now");
    el.textContent = eligible > 0 ? `${totalEth} ETH` : "0 ETH";

    // (Optional) disable/enable the Redeem button
    const headerBtn = document.querySelector(".redeem-btn");
    if (headerBtn) headerBtn.disabled = eligible === 0;

  } catch (e) {
    console.error("Failed to load redeemable value:", e);
    const el = document.getElementById("redeemable-now");
    if (el) el.textContent = "—";
  }
}
  // ===== Boot =====
  window.addEventListener("load", initCharacterStatus);
</script>



<script src="/static/main.js"></script>
</body>
</html>
