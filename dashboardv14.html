<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proofpulse</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css" />
  <style>
  /* ===== Base layout ===== */
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: url('assets/images/DB_BG.jpg') no-repeat center center fixed;
    color: #fff;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background-color: #0000FF; /* brand blue */
    z-index: 3;
    position: relative;
  }
  .logo img { height: 50px; }

  .redeem-btn {
    background-color: #fff;
    color: #0000FF;
    font-weight: bold;
    font-size: 16px;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s, transform .1s ease-in-out;
  }
  .redeem-btn:hover { background-color: #f1f5ff; }
  .redeem-btn:disabled { opacity:.6; cursor:not-allowed; }

  .bg-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1;
  }
  .main-content { position: relative; z-index: 2; }
  .container { padding: 2rem; max-width: 1200px; margin: auto; }

  /* ===== Dashboard grid ===== */
  .dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 2rem;
    grid-template-areas:
      "character character character"
      "metrics activity rewards"
      "quests quests quests"
      "streaks streaks streaks";
  }
  @media (max-width: 1024px){
    .dashboard { grid-template-columns: 1fr; grid-template-areas: "character" "metrics" "activity" "rewards" "quests" "streaks"; }
  }

  /* ===== Cards ===== */
  .card {
    background: #fff;
    color: #222;
    padding: 2rem;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.10);
    transition: transform 0.2s, box-shadow .2s;
  }
  .card:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,0,0,0.12); }
  .card h3 { margin-top: 0; }

  .stats-table { width: 100%; border-collapse: collapse; }
  .stats-table td { padding: 0.5rem 0; }

  .progress {
    background: #eee;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 0.5rem;
  }
  .progress-bar { height: 10px; background: #FF00B4; } /* keep your pink XP bar */

  .character-card { grid-area: character; padding: 2.5rem; font-size: 1.1rem; text-align: center; }
  .character-avatar {
    width: 120px; height: 120px; border-radius: 50%; margin-bottom: 1rem;
    object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  .metrics-card { grid-area: metrics; }
  .activity-card { grid-area: activity; }
  .rewards-card { grid-area: rewards; }
  .quests-card { grid-area: quests; }

  /* ===== Activity Calendar ===== */
  #activity-calendar {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 0.75rem; background: #ffffff; padding: 1.5rem; border-radius: 20px;
    color: #222; font-size: 0.95rem; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    margin-top: 1rem;
  }
  #activity-calendar div {
    text-align: center; padding: 1rem; border-radius: 12px; font-weight: 600;
    background-color: #f3f3f3; transition: all 0.2s ease;
  }
  #activity-calendar div:hover { transform: scale(1.05); background-color: #eaeaea; }
  #activity-calendar .weekday { background-color: transparent; color: #333; font-weight: 700; padding: 0.5rem 0; cursor: default; }
  #activity-calendar .active-day { background-color: #d1e7dd; color: #155724; }

  /* ===== Simple quest list (used by earlier version) ===== */
  .quest-item { padding: .5rem 0; display:flex; justify-content:space-between; gap:.75rem; }
  .quest-item.done { color: #1e7e34; font-weight: 600; }
  .quest-status { opacity:.8; }

  /* ===== THEME-ALIGNED QUEST CARDS (white + blue) ===== */
/* Quest cards tuned to your theme */
.quest-grid{
  display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:1rem
}
@media (max-width:1200px){.quest-grid{grid-template-columns:repeat(2,minmax(220px,1fr))}}
@media (max-width:640px){.quest-grid{grid-template-columns:1fr}}

.quest-card{
  position:relative;background:#fff;border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);padding:18px;color:#222
}
.quest-card .ribbon{
  position:absolute;top:-14px;left:20px;display:flex;align-items:center;gap:.5rem;
  background:#5a382b;color:#fff;border-radius:12px;padding:6px 12px 7px;
  box-shadow:0 3px 0 rgba(0,0,0,.25), 0 6px 14px rgba(0,0,0,.15)
}
.ribbon .coin{font-size:1rem}
.ribbon .amount{font-weight:800;letter-spacing:.2px}

.quest-card .title{font-weight:800;font-size:1.05rem;margin:18px 0 6px}
.quest-card .desc{font-size:.95rem;color:#666}

.quest-card .progress{background:#e9ecef;border-radius:999px;overflow:hidden;height:10px;margin-top:8px}
.quest-card .bar{height:100%;width:0%;background:#2a2aff;transition:width .3s ease}
.quest-card.done .bar{background:#22c55e}

.quest-card .count{display:flex;justify-content:space-between;margin-top:8px;font-weight:700;color:#444}

</style>

</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html"><img src="assets/images/logobw.png" alt="Proofpulse" /></a>
    </div>
    <div>
      <button class="redeem-btn" onclick="redeemAllEligible()">üéÅ Redeem</button>
      <a href="index.html" style="color: white; margin-left: 1rem;">Logout</a>
    </div>
  </header>

  <div class="bg-overlay"></div>
  <div class="main-content">
    <div class="container">
      <h1>Welcome, FitWarrior! ‚ú®</h1>
  
      <div class="dashboard">
        <div class="card character-card">
          <img src="https://cdn-icons-png.flaticon.com/512/5719/5719910.png" alt="Avatar" class="character-avatar">
          <h3>üë§ Character Status</h3>

          <p><strong>Level:</strong> <span id="level-value">-</span></p>
          <p><strong>XP:</strong> <span id="xp-value">-</span></p>

          <div class="progress">
          <div class="progress-bar" style="width: 0%"></div>
          </div>

          <p><strong>Badges:</strong> Early Bird</p>
          <hr style="margin: 1.5rem 0;">

          <div class="mt-4 p-4 border rounded bg-white text-black" style="margin-top:1.5rem;">
        <h3>üß† Upload GPX for Verification</h3>
        <input type="file" id="gpxFileInput" accept=".gpx" />
        <button onclick="verifyWorkout()" class="btn mt-2 bg-blue-600 text-white px-4 py-2 rounded">Start Verification</button>
       <div id="mlResult" class="mt-2 text-sm text-gray-800"></div>
        </div>
           <hr style="margin: 1.5rem 0;">

                 
          <h3>ü©∫ Health ID Proof</h3>
          
          <p>Date of Birth: <span id="health-dob">Loading...</span></p>
          <p>Policy No: <span id="health-policy">Loading...</span></p>
          <p>Contract Value: <span id="health-contract">Loading...</span></p>
          <p>Insurer: <span id="health-insurer">Loading...</span></p>



        </div>
  
        <div class="card metrics-card">
          <h3>üèãÔ∏è Body Metrics</h3>
          <table class="stats-table">
            <tr><td>Height:</td><td>169 cm</td></tr>
            <tr><td>Weight:</td><td>77.3 kg</td></tr>
            <tr><td>Body Fat:</td><td>20.8%</td></tr>
          </table>
        </div>
  
        <div class="card activity-card">
          <h3>üö∂Ô∏è Daily Activity</h3>
          <table class="stats-table">
            <tr><td>Steps:</td><td id="steps">-</td></tr>
            <tr><td>Sleep:</td><td id="sleep">-</td></tr>
            <tr><td>Calories:</td><td id="calories">-</td></tr>
          </table>
        </div>
  
        <div class="card rewards-card">
        <h3>üåü Total Rewards</h3>
        
        <p><strong>Total ETH earned:</strong> <span id="total-earned">‚Äî</span></p>
        <p><strong>Today:</strong> <span id="earned-today">‚Äî</span></p>
        <p><strong>Redeemable now:</strong> <span id="redeemable-now">Calculating‚Ä¶</span></p>
        </div>


  
        <div class="card quests-card quests">
          <h3>üöÄ Daily Quests</h3>
          <div id="daily-quests" class="quest-grid"></div>
        </div>
  
        <div class="card quests-card" style="grid-area: streaks;">
          <h3>üìÖ Activity Calendar</h3>
          <div style="margin-bottom: 1rem;">
            <label for="quest-filter" style="margin-right: 0.5rem;">Filter by Quest:</label>
            <select id="quest-filter">
              <option value="all">All</option>
              <option value="walking">üö∂ Walking</option>
              <option value="running30min">üèÉ‚Äç‚ôÇÔ∏è Run 30min</option>
              <option value="running45min">üèÉ‚Äç‚ôÇÔ∏è Run 45min</option>
              <option value="run5k">üèÅ Run 5K</option>
              <option value="run10k">üèÅ Run 10K</option>
              <option value="cycling5k">üö¥‚Äç‚ôÇÔ∏è Cycle 5K</option>
              <option value="cycling10k">üö¥‚Äç‚ôÇÔ∏è Cycle 10K</option>
              <option value="gym_checkin">üèãÔ∏è‚Äç‚ôÇÔ∏è Gym Check-in</option>
              <option value="hiit25">üî• HIIT 25min</option>
            </select>
          </div>
          <div id="activity-calendar"></div>
        </div>
      </div>
    </div>
  </div>


<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script>
/* =================== Addresses & ABIs =================== */
const activityLoggerAddress = "0x26E24bfe2A21515eb91Cea4b754FA56067bC70cB";
const healthIdAddress      = "0x7bC0fC7A7EF15FA2839c32F6a3b04B2edD3e3e68";

const activityLoggerAbi = [
  "function getUserActivities(address user) view returns ((uint256 distanceKmX100,uint256 elevationGainM,uint256 timestamp,bool isRewarded)[])",
  "function getThresholds() view returns (uint256 distanceThreshold,uint256 elevationThreshold)",
  "function rewardAmount() view returns (uint256)",
  "function redeemReward()",
  "event ActivityLogged(address indexed user,uint256 distanceKmX100,uint256 elevationGainM,uint256 timestamp)",
  "event RewardRedeemed(address indexed user,uint256 amount,uint256 eligibleCount)"
];

const healthIdAbi = [
  {
    "inputs":[{"internalType":"address","name":"","type":"address"}],
    "name":"users",
    "outputs":[
      {"internalType":"address","name":"user","type":"address"},
      {"internalType":"string","name":"name","type":"string"},
      {"internalType":"uint256","name":"dob","type":"uint256"},
      {"internalType":"string","name":"policyNo","type":"string"},
      {"internalType":"uint256","name":"contractValue","type":"uint256"},
      {"internalType":"address","name":"insurer","type":"address"}
    ],
    "stateMutability":"view","type":"function"
  },
  {
    "inputs":[{"internalType":"address","name":"user","type":"address"}],
    "name":"getUserInsurerInfo",
    "outputs":[
      {"internalType":"string","name":"insurerName","type":"string"},
      {"internalType":"address","name":"insurerAddress","type":"address"},
      {"internalType":"string","name":"licenseInfo","type":"string"}
    ],
    "stateMutability":"view","type":"function"
  }
];

/* =================== Character constants =================== */
const XP_PER_ACTIVITY = 10;
const XP_PER_LEVEL = 100;

/* =================== Helpers =================== */
function formatDobValue(dobBig) {
  const val = typeof dobBig === "object" && dobBig?._isBigNumber
    ? parseInt(dobBig.toString(), 10)
    : Number(dobBig);
  if (!val || Number.isNaN(val)) return "Not set";
  const date = val > 10000000000 ? new Date(val) : new Date(val * 1000);
  return date.toLocaleDateString("en-GB");
}

/* =================== Quest card CSS (injected) =================== */
(function injectQuestCSS(){
  const css = document.createElement("style");
  css.textContent = `
    .quest-grid{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:1rem}
    .quest-card{position:relative;background:#f7efe1;border:3px solid #b08a5a;border-radius:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.18);padding:14px;color:#2c2419}
    .quest-card .ribbon{position:absolute;top:-12px;left:12px;background:#8b3f1f;color:#fff;
      padding:6px 10px;border-radius:8px;box-shadow:0 3px 0 rgba(0,0,0,.25);font-weight:700;display:flex;align-items:center;gap:.4rem}
    .quest-card .ribbon .coin{font-size:1.1rem}
    .quest-card .title{font-weight:800;font-size:1rem;margin:18px 0 6px 0;letter-spacing:.2px}
    .quest-card .desc{font-size:.95rem;margin:0 0 10px 0}
    .quest-card .progress{background:#d7c7a9;border-radius:999px;overflow:hidden;height:12px;margin-top:6px}
    .quest-card .bar{height:100%;width:0%;background:#5aa54a}
    .quest-card .count{display:flex;justify-content:space-between;margin-top:6px;font-weight:700}
    .quest-card.done .bar{background:#2fa24a}
  `;
  document.head.appendChild(css);
})();

/* =================== Quests state =================== */
let QUESTS = [
  { id:'q-5k',    reward:'0.001 ETH',  title:'Daily', desc:'Run 5 km',                goal:1, progress:0, done:false },
  { id:'q-elev',  reward:'0.001 ETH',  title:'Daily', desc:'Step up 100 m',           goal:1, progress:0, done:false },
  { id:'q-sleep', reward:'0.001 ETH',  title:'Daily', desc:'Sleep 8 hours',           goal:1, progress:0, done:false }, // static
  { id:'q-ex30',  reward:'0.001 ETH', title:'Daily', desc:'Exercise 30 minutes',     goal:1, progress:0, done:false }  // static
];

function renderQuestCards(){
  const wrap = document.getElementById("daily-quests");
  if(!wrap) return;
  wrap.classList.add("quest-grid");
  wrap.innerHTML = QUESTS.map(q => `
    <div class="quest-card ${q.done ? 'done':''}" id="${q.id}">
      <div class="ribbon"><span class="coin">ü™ô</span>${q.reward}</div>
      <div class="title">${q.title}</div>
      <div class="desc">${q.desc}</div>
      <div class="progress"><div class="bar" style="width:${Math.min(100, Math.round((q.progress/q.goal)*100))}%"></div></div>
      <div class="count"><span>${q.progress} / ${q.goal}</span><span></span></div>
    </div>
  `).join('');
}

function setQuestProgress(id, progress){
  const q = QUESTS.find(x => x.id === id);
  if(!q) return;
  q.progress = Math.min(progress, q.goal);
  q.done = q.progress >= q.goal;

  const el = document.getElementById(id);
  if(!el) return;
  el.classList.toggle("done", q.done);
  const bar = el.querySelector(".bar");
  if(bar) bar.style.width = `${Math.min(100, Math.round((q.progress/q.goal)*100))}%`;
  const count = el.querySelector(".count");
  if(count) count.firstElementChild.textContent = `${q.progress} / ${q.goal}`;
}

/* =================== Boot flow =================== */
async function initCharacterStatus() {
  try {
    if (!window.ethereum) throw new Error("Wallet not found");
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const user = await signer.getAddress();

    // Character status
    const activity = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const activities = await activity.getUserActivities(user);
    const count = activities.length;
    const xp = count * XP_PER_ACTIVITY;
    const level = Math.floor(xp / XP_PER_LEVEL) + 1;
    const xpIntoLevel = xp % XP_PER_LEVEL;
    const pct = Math.floor((xpIntoLevel / XP_PER_LEVEL) * 100);
    document.getElementById("level-value").textContent = level;
    document.getElementById("xp-value").textContent = xp;
    document.querySelector(".progress-bar").style.width = pct + "%";

    // Health + Rewards
    await loadHealthID(user, provider);
    await loadOverallEarnings(provider, user);
    await loadRedeemableValue(provider, user);

    // Mock daily activity UI
    fetchMockData();

    // Quests: render + evaluate for today
    renderQuestCards();
    await updateDailyQuestStatus(provider, user);

    // Live refresh on events
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    logger.on("ActivityLogged", (u) => {
      if (u.toLowerCase() === user.toLowerCase()) {
        updateDailyQuestStatus(provider, user);
        loadOverallEarnings(provider, user);
        loadRedeemableValue(provider, user);
      }
    });
    logger.on("RewardRedeemed", (u) => {
      if (u.toLowerCase() === user.toLowerCase()) {
        loadOverallEarnings(provider, user);
        loadRedeemableValue(provider, user);
      }
    });

  } catch (err) {
    console.error(err);
  }
}

/* =================== HealthID =================== */
async function loadHealthID(userAddress, provider) {
  try {
    const health = new ethers.Contract(healthIdAddress, healthIdAbi, provider);
    const u = await health.users(userAddress);
    if (u.name && u.name.length) {
      const h1 = document.querySelector("h1");
      if (h1) h1.textContent = `Welcome, ${u.name}! ‚ú®`;
    }
    document.getElementById("health-dob").textContent      = formatDobValue(u.dob);
    document.getElementById("health-policy").textContent   = u.policyNo;
    document.getElementById("health-contract").textContent = `${ethers.utils.formatEther(u.contractValue)} ETH`;
    const info = await health.getUserInsurerInfo(userAddress);
    document.getElementById("health-insurer").textContent  = `${info.insurerName} (${info.insurerAddress})`;
  } catch (error) {
    console.error("Error loading Health ID:", error);
  }
}

/* =================== Mock daily activity =================== */
async function fetchMockData() {
  try {
    const response = await fetch('assets/mock/mockhealthdata.json');
    const data = await response.json();
    document.querySelector('#steps').textContent    = `${data.steps.toLocaleString()} steps`;
    document.querySelector('#sleep').textContent    = `${data.sleep} hrs`;
    document.querySelector('#calories').textContent = `${data.calories} kcal`;
  } catch (error) {
    console.error('Failed to fetch mock data:', error);
  }
}

/* =================== Rewards: Redeemable now =================== */
async function loadRedeemableValue(provider, userAddress) {
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const [activities, [distTh, elevTh], rewardWei] = await Promise.all([
      logger.getUserActivities(userAddress),
      logger.getThresholds(),
      logger.rewardAmount()
    ]);

    let eligible = 0;
    for (const a of activities) {
      const distOK = ethers.BigNumber.from(a.distanceKmX100 ?? a[0]).gte(distTh);
      const elevOK = ethers.BigNumber.from(a.elevationGainM ?? a[1]).gte(elevTh);
      const notPaid = !(a.isRewarded ?? a[3]);
      if (notPaid && (distOK || elevOK)) eligible++;
    }

    const totalWei = ethers.BigNumber.from(rewardWei).mul(eligible);
    document.getElementById("redeemable-now").textContent =
      eligible > 0 ? `${ethers.utils.formatEther(totalWei)} ETH` : "0 ETH";

  } catch (e) {
    console.error("Failed to load redeemable value:", e);
    const el = document.getElementById("redeemable-now");
    if (el) el.textContent = "‚Äî";
  }
}

/* =================== Rewards: Overall & Today =================== */
async function loadOverallEarnings(provider, userAddress) {
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const [activities, [distTh, elevTh], rewardWei] = await Promise.all([
      logger.getUserActivities(userAddress),
      logger.getThresholds(),
      logger.rewardAmount(),
    ]);

    const midnight = new Date(); midnight.setHours(0,0,0,0);
    const todayStart = Math.floor(midnight.getTime() / 1000);

    let totalEligible = 0;
    let todayEligible = 0;

    for (const a of activities) {
      const dist = a.distanceKmX100 ?? a[0];
      const elev = a.elevationGainM ?? a[1];
      const ts   = Number(a.timestamp ?? a[2]);

      const eligible = ethers.BigNumber.from(dist).gte(distTh) || ethers.BigNumber.from(elev).gte(elevTh);
      if (eligible) {
        totalEligible++;
        if (ts >= todayStart) todayEligible++;
      }
    }

    const totalWei = ethers.BigNumber.from(rewardWei).mul(totalEligible);
    const todayWei = ethers.BigNumber.from(rewardWei).mul(todayEligible);

    document.getElementById("total-earned").textContent = `${ethers.utils.formatEther(totalWei)} ETH`;
    document.getElementById("earned-today").textContent = `+${ethers.utils.formatEther(todayWei)} ETH`;

  } catch (e) {
    console.error("Failed to load overall earnings:", e);
    const te = document.getElementById("total-earned");
    const td = document.getElementById("earned-today");
    if (te) te.textContent = "‚Äî";
    if (td) td.textContent = "‚Äî";
  }
}

/* =================== Redeem button =================== */
async function redeemAllEligible() {
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const contract = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, signer);

    const btn = document.querySelector(".redeem-btn");
    if (btn) { btn.disabled = true; btn.textContent = "Redeeming‚Ä¶"; }
    const tx = await contract.redeemReward();
    await tx.wait();
    if (btn) { btn.disabled = false; btn.textContent = "üéÅ Redeem"; }

    const user = await signer.getAddress();
    await loadRedeemableValue(provider, user);
    await loadOverallEarnings(provider, user);
    await updateDailyQuestStatus(provider, user);

  } catch (e) {
    console.error("Redeem failed:", e);
    const btn = document.querySelector(".redeem-btn");
    if (btn) { btn.disabled = false; btn.textContent = "üéÅ Redeem"; }
  }
}

/* =================== Quests: today-only completion for 5km & 100m =================== */
async function updateDailyQuestStatus(provider, userAddress){
  try {
    const logger = new ethers.Contract(activityLoggerAddress, activityLoggerAbi, provider);
    const activities = await logger.getUserActivities(userAddress);

    const midnight = new Date(); midnight.setHours(0,0,0,0);
    const todayStart = Math.floor(midnight.getTime()/1000);

    let prog5k = 0, progElev = 0;

    for(const a of activities){
      const dist = a.distanceKmX100 ?? a[0]; // x100 (500 = 5.00 km)
      const elev = a.elevationGainM ?? a[1]; // meters
      const ts   = Number(a.timestamp ?? a[2]);
      if (ts < todayStart) continue;

      if (ethers.BigNumber.from(dist).gte(500)) prog5k = 1;
      if (ethers.BigNumber.from(elev).gte(100)) progElev = 1;
      if (prog5k && progElev) break;
    }

    setQuestProgress('q-5k',   prog5k);
    setQuestProgress('q-elev', progElev);
    // q-sleep & q-ex30 remain static per your request
  } catch(e){
    console.error("Failed to update quests:", e);
  }
}

/* =================== Boot =================== */
window.addEventListener("load", initCharacterStatus);
</script>





<script src="/static/main.js"></script>
</body>
</html>
