<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proofpulse</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #0000FF, #5C6EFF);
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background-color: #FF00B4;
    }
    .logo img {
      height: 50px;
    }
    .redeem-btn {
      background-color: #fff;
      color: #FF00B4;
      font-weight: bold;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .redeem-btn:hover {
      background-color: #ffe6f0;
    }
    .container {
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
    }
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 2rem;
      grid-template-areas:
        "character character character"
        "metrics activity rewards"
        "quests quests quests"
        "streaks streaks streaks";
    }
    .card {
      background: #fff;
      color: #222;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    .character-card { grid-area: character; text-align: center; }
    .character-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-bottom: 1rem;
    }
    .progress {
      background: #eee;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-bar {
      height: 10px;
      background: #FF00B4;
      width: 0%;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="#"><img src="logo.png" alt="Proofpulse" /></a>
    </div>
    <div>
      <button class="redeem-btn">üéÅ Redeem</button>
      <a href="#" style="color: white; margin-left: 1rem;">Logout</a>
    </div>
  </header>

  <div class="container">
    <h1>Welcome, FitWarrior! ‚ú®</h1>
    <div class="dashboard">
      <div class="card character-card">
        <img src="https://cdn-icons-png.flaticon.com/512/5719/5719910.png" class="character-avatar">
        <h3>üë§ Character Status</h3>
        <p><strong>Level:</strong> -</p>
        <p><strong>XP:</strong> -</p>
        <div class="progress"><div class="progress-bar"></div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    const contractAddress = "0x871Ee5907cd8b60e298CAD61fFcf74d55262dfb7";
    const contractABI = [
      "function getUserVerifiedActivities(address user) external view returns (bytes32[] memory)",
      "function getActivity(bytes32 activityHash) external view returns (tuple(bytes32,uint256,string,address,bool,bool))"
    ];

    const EXP_MAP = {
      walking: 3,
      running30min: 3,
      running45min: 5,
      run5k: 10,
      run10k: 20,
      cycling5k: 3,
      cycling10k: 10,
      gym_checkin: 3,
      hiit25: 5
    };

    const MAX_LEVEL = 10;
    const LEVEL_XP = [0, 100, 250, 450, 700, 1000, 1400, 1900, 2500, 3250, 6000];

    function getLevelFromXP(xp) {
      for (let i = LEVEL_XP.length - 1; i >= 0; i--) {
        if (xp >= LEVEL_XP[i]) return i;
      }
      return 0;
    }

    function getTitle(level) {
      const titles = [
        "Beginner", "Mover", "Sweat Starter", "Cardio Cadet",
        "HIIT Hero", "Fitness Pro", "Champion", "Sweat Slayer",
        "Endurance Beast", "Proofpulse Legend"
      ];
      return titles[level] || "Athlete";
    }

    async function loadCharacterData() {
      if (!window.ethereum) return;

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const signer = provider.getSigner();
      const user = await signer.getAddress();
      const contract = new ethers.Contract(contractAddress, contractABI, provider);

      const hashes = await contract.getUserVerifiedActivities(user);
      let totalXP = 0;

      for (let i = 0; i < hashes.length; i++) {
        const activity = await contract.getActivity(hashes[i]);
        const type = activity[2];
        totalXP += EXP_MAP[type] || 0;
      }

      const level = getLevelFromXP(totalXP);
      const nextXP = LEVEL_XP[level + 1] || LEVEL_XP[MAX_LEVEL];
      const currentXP = totalXP - LEVEL_XP[level];
      const xpToNext = nextXP - LEVEL_XP[level];
      const xpPercent = Math.min(100, Math.round((currentXP / xpToNext) * 100));

      document.querySelector('.character-card p:nth-of-type(2)').innerHTML =
        `<strong>Level:</strong> ${level} - "${getTitle(level)}"`;

      document.querySelector('.character-card p:nth-of-type(3)').innerHTML =
        `<strong>XP:</strong> ${totalXP} / ${nextXP}`;

      document.querySelector('.progress-bar').style.width = `${xpPercent}%`;
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadCharacterData();
    });
  </script>
</body>
</html>
