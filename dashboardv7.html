<script>
  let currentMonthOffset = 0; // 0 = current month

  function renderCalendar(activityDates) {
    const calendarEl = document.getElementById("activity-calendar");
    calendarEl.innerHTML = "";

    const today = new Date();
    const target = new Date(today.getFullYear(), today.getMonth() + currentMonthOffset, 1);

    const year = target.getFullYear();
    const month = target.getMonth();
    const monthLabel = target.toLocaleString("default", { month: "long", year: "numeric" });
    document.getElementById("calendar-title").textContent = monthLabel;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    for (const day of weekdays) {
      const label = document.createElement("div");
      label.textContent = day;
      label.className = "weekday";
      calendarEl.appendChild(label);
    }

    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement("div");
      calendarEl.appendChild(empty);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
      const cell = document.createElement("div");
      cell.textContent = day;
      if (activityDates.has(dateStr)) {
        cell.classList.add("active-day");
      }
      calendarEl.appendChild(cell);
    }
  }

  async function loadDashboardData() {
    if (!window.ethereum) return;

    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    const user = await signer.getAddress();
    const contract = new ethers.Contract(contractAddress, contractABI, provider);

    const hashes = await contract.getUserVerifiedActivities(user);
    const today = new Date().toISOString().split("T")[0];
    const completedToday = new Set();
    const activityDates = new Set();

    for (let i = 0; i < hashes.length; i++) {
      const activity = await contract.getActivity(hashes[i]);
      const type = activity[2];
      const dateStr = new Date(activity[1] * 1000).toISOString().split("T")[0];
      activityDates.add(dateStr);
      if (dateStr === today) completedToday.add(type);
    }

    const questList = document.getElementById("daily-quests");
    questList.innerHTML = "";
    for (const type of questTypes) {
      const done = completedToday.has(type);
      const li = document.createElement("li");
      li.innerHTML = `
        <div style="
          background: ${done ? '#d1e7dd' : '#f1f1f1'};
          color: ${done ? '#155724' : '#333'};
          padding: 0.75rem 1rem;
          border-radius: 8px;
          margin-bottom: 0.5rem;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-weight: 500;
        ">
          <span>${questLabels[type] || type}</span>
          ${done ? 'âœ…' : ''}
        </div>
      `;
      questList.appendChild(li);
    }

    renderCalendar(activityDates);

    // Handle month navigation
    document.getElementById("prev-month").onclick = () => {
      if (currentMonthOffset > -2) {
        currentMonthOffset--;
        renderCalendar(activityDates);
      }
    };

    document.getElementById("next-month").onclick = () => {
      if (currentMonthOffset < 0) {
        currentMonthOffset++;
        renderCalendar(activityDates);
      }
    };
  }

  window.addEventListener("DOMContentLoaded", () => {
    fetchMockData();
    setInterval(fetchMockData, 10000);
    loadDashboardData();
  });
</script>
